<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - AIå‡ºé€€å‹¤ã‚·ã‚¹ãƒ†ãƒ </title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 0; padding: 0;
      background: #f1f5f9; color: #334155;
    }
    header {
      background: #1e293b; color: white;
      padding: 1rem 2rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    h1 { margin: 0; font-size: 1.2rem; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .container {
      max-width: 800px; margin: 2rem auto; padding: 0 1rem;
    }
    .card {
      background: white; padding: 2rem; border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    h2 { margin-top: 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
    
    .btn {
      padding: 0.5rem 1rem; border-radius: 6px; border: none;
      font-weight: bold; cursor: pointer; transition: 0.2s;
      text-decoration: none; display: inline-block; font-size: 0.9rem;
    }
    .btn-primary { background: #3b82f6; color: white; padding: 0.75rem 1.5rem; font-size: 1rem; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-back { background: #64748b; color: white; }
    .btn-logout { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #cbd5e1; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    .user-list { list-style: none; padding: 0; }
    .user-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem; border-bottom: 1px solid #f1f5f9;
    }
    .user-item:last-child { border-bottom: none; }
    
    .loading { text-align: center; color: #94a3b8; margin: 2rem 0; }
    input[type="text"], input[type="password"] {
      padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px;
    }

    /* â–¼â–¼â–¼ ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ (è¿½åŠ ) â–¼â–¼â–¼ */
    @media (max-width: 600px) {
      header {
        flex-direction: column; /* ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
        align-items: flex-start; /* å·¦å¯„ã› */
        gap: 10px; /* ä¸Šä¸‹ã®é–“éš” */
        padding: 1rem; /* ä½™ç™½ã‚’å°‘ã—ç‹­ã */
      }

      header h1 {
        font-size: 1rem; /* ä¼šç¤¾åã‚’å°‘ã—å°ã•ã */
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* é•·ã™ãã‚‹å ´åˆã¯...ã«ã™ã‚‹ */
      }

      /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆç®¡ç†ç”»é¢ç”¨ã‚¯ãƒ©ã‚¹ï¼‰ */
      .header-actions {
        width: 100%;
        display: flex;
        justify-content: flex-end; /* å³å¯„ã› */
        gap: 10px;
      }

      /* æ‰“åˆ»ç”»é¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼å³å´divç”¨ */
      header > div {
        width: 100%;
        justify-content: flex-end; /* å³å¯„ã› */
      }

      /* ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
      .btn, button, a {
        font-size: 0.85rem !important;
        padding: 6px 12px !important;
      }
    }


  </style>
</head>
<body>

  <header>
    <h1 id="headerTitle">ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div class="header-actions">
      <a href="/" class="btn btn-back">æ‰“åˆ»ç”»é¢ã¸</a>
      <button onclick="logout()" class="btn btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <div class="container">
    
    <!-- ä¼šç¤¾åå¤‰æ›´ -->
    <div class="card">
      <h2>ğŸ¢ ä¼šç¤¾è¨­å®š</h2>
      <p>ã‚·ã‚¹ãƒ†ãƒ ã«è¡¨ç¤ºã•ã‚Œã‚‹ä¼šç¤¾åã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="companyNameInput" placeholder="æ–°ã—ã„ä¼šç¤¾å">
        <button onclick="updateCompanyName()" class="btn btn-primary" style="white-space: nowrap;">å¤‰æ›´</button>
      </div>
    </div>

    <!-- CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
    <div class="card">
      <h2>ğŸ“Š å‹¤æ€ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>
      <p>å…¨æœŸé–“ã®å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
      <button onclick="downloadCsv()" class="btn btn-primary">ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <!-- å¾“æ¥­å“¡ç®¡ç† -->
    <div class="card">
      <h2>ğŸ‘¥ å¾“æ¥­å“¡ç®¡ç†</h2>
      <div id="userList" class="user-list">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ -->
    <div class="card" style="border-top: 4px solid #f59e0b;">
      <h2>ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
      <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px;">
        <input type="password" id="currentPass" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <input type="password" id="newPass" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button onclick="changePassword()" class="btn btn-warning">å¤‰æ›´ã™ã‚‹</button>
      </div>
    </div>

  </div>

  <script>
    const API_URL = ''; 
    const COMPANY_ID = localStorage.getItem('attendance_company_id');
    const COMPANY_NAME = localStorage.getItem('attendance_company_name');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ & ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
    if (!COMPANY_ID) {
      window.location.href = '/login';
    } else {
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¼šç¤¾åã‚’è¡¨ç¤º
      const headerH1 = document.getElementById('headerTitle');
      if(COMPANY_NAME) {
        headerH1.textContent += ` - ${COMPANY_NAME}`;
        document.getElementById('companyNameInput').value = COMPANY_NAME;
      }
    }

    function logout() {
      if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem('attendance_company_id');
        localStorage.removeItem('attendance_company_name');
        window.location.href = '/login';
      }
    }

    // ä¼šç¤¾åå¤‰æ›´
    async function updateCompanyName() {
      const newName = document.getElementById('companyNameInput').value;
      if(!newName) return alert('ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

      try {
        const res = await fetch('/api/update-company-name', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyId: COMPANY_ID, newName: newName })
        });

        if((await res.json()).success) {
          alert('ä¼šç¤¾åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
          localStorage.setItem('attendance_company_name', newName);
          location.reload(); // ç”»é¢æ›´æ–°
        } else {
          alert('å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch(e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    }

    function downloadCsv() {
      window.location.href = `/api/download-csv?companyId=${COMPANY_ID}`;
    }

    async function loadUsers() {
      const listEl = document.getElementById('userList');
      try {
        const res = await fetch(`/api/users?companyId=${COMPANY_ID}`);
        const users = await res.json();

        if (users.length === 0) {
          listEl.innerHTML = '<p style="text-align:center; color:#94a3b8;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¾“æ¥­å“¡ã¯ã„ã¾ã›ã‚“</p>';
          return;
        }

        listEl.innerHTML = users.map(user => `
          <li class="user-item">
            <span>
              <strong>${escapeHtml(user.name)}</strong>
              <small style="color:#94a3b8; margin-left:10px;">ID: ${user.id}</small>
            </span>
            <button onclick="deleteUser(${user.id}, '${escapeHtml(user.name)}')" class="btn btn-danger">å‰Šé™¤</button>
          </li>
        `).join('');
      } catch (err) {
        listEl.innerHTML = '<p style="color:red; text-align:center;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
      }
    }

    async function deleteUser(userId, userName) {
      if (!confirm(`${userName} ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆâ€»ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰`)) return;

      try {
        const res = await fetch(`/api/users/${userId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyId: COMPANY_ID })
        });

        if (res.ok) {
          alert('å‰Šé™¤ã—ã¾ã—ãŸ');
          loadUsers(); 
        } else {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (err) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
    async function changePassword() {
      const currentPass = document.getElementById('currentPass').value;
      const newPass = document.getElementById('newPass').value;
      // æ³¨æ„: æœ¬æ¥ã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä½¿ã†ã¹ãã§ã™ãŒã€ä»Šå›ã¯åˆæœŸadminæƒ³å®š
      const username = 'admin'; 

      if (!currentPass || !newPass) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (confirm('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
        try {
          const res = await fetch('/api/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, currentPassword: currentPass, newPassword: newPass })
          });

          const data = await res.json();

          if (data.success) {
            alert('å¤‰æ›´ã—ã¾ã—ãŸï¼\næ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
            logout(); 
          } else {
            alert(data.error || 'å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } catch (err) {
          alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
      });
    }

    // åˆæœŸèª­ã¿è¾¼ã¿
    loadUsers();
  </script>
</body>
</html>
