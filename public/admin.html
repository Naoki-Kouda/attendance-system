<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - AIå‡ºé€€å‹¤ã‚·ã‚¹ãƒ†ãƒ </title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 0; padding: 0;
      background: #f1f5f9; color: #334155;
    }
    header {
      background: #1e293b; color: white;
      padding: 1rem 2rem;
      display: flex; justify-content: space-between; align-items: center;
    }
    h1 { margin: 0; font-size: 1.2rem; }
    .container {
      max-width: 800px; margin: 2rem auto; padding: 0 1rem;
    }
    .card {
      background: white; padding: 2rem; border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    h2 { margin-top: 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn {
      padding: 0.75rem 1.5rem; border-radius: 8px; border: none;
      font-weight: bold; cursor: pointer; transition: 0.2s;
      text-decoration: none; display: inline-block;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-danger { background: #ef4444; color: white; font-size: 0.8rem; padding: 0.4rem 0.8rem; }
    .btn-back { background: #64748b; color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* ãƒªã‚¹ãƒˆ */
    .user-list { list-style: none; padding: 0; }
    .user-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem; border-bottom: 1px solid #f1f5f9;
    }
    .user-item:last-child { border-bottom: none; }
    
    .loading { text-align: center; color: #94a3b8; margin: 2rem 0; }
  </style>
</head>
<body>

  <header>
    <h1>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <a href="/" class="btn btn-back">ğŸ“· æ‰“åˆ»ç”»é¢ã¸æˆ»ã‚‹</a>
  </header>

  <div class="container">
    
    <!-- CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
    <div class="card">
      <h2>ğŸ“Š å‹¤æ€ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h2>
      <p>å…¨æœŸé–“ã®å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
      <button onclick="downloadCsv()" class="btn btn-primary">ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <!-- å¾“æ¥­å“¡ç®¡ç† -->
    <div class="card">
      <h2>ğŸ‘¥ å¾“æ¥­å“¡ç®¡ç†</h2>
      <div id="userList" class="user-list">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

  </div>

  <script>
    const API_URL = ''; // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ãªã‚‰ç©ºã§OK
    const COMPANY_ID = localStorage.getItem('attendance_company_id');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    if (!COMPANY_ID) {
      window.location.href = '/login';
    }

    // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadCsv() {
      window.location.href = `/api/download-csv?companyId=${COMPANY_ID}`;
    }

    // å¾“æ¥­å“¡ãƒªã‚¹ãƒˆå–å¾—
    async function loadUsers() {
      const listEl = document.getElementById('userList');
      try {
        const res = await fetch(`/api/users?companyId=${COMPANY_ID}`);
        const users = await res.json();

        if (users.length === 0) {
          listEl.innerHTML = '<p style="text-align:center; color:#94a3b8;">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¾“æ¥­å“¡ã¯ã„ã¾ã›ã‚“</p>';
          return;
        }

        listEl.innerHTML = users.map(user => `
          <li class="user-item">
            <span>
              <strong>${escapeHtml(user.name)}</strong>
              <small style="color:#94a3b8; margin-left:10px;">ID: ${user.id}</small>
            </span>
            <button onclick="deleteUser(${user.id}, '${escapeHtml(user.name)}')" class="btn btn-danger">å‰Šé™¤</button>
          </li>
        `).join('');
      } catch (err) {
        listEl.innerHTML = '<p style="color:red; text-align:center;">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
      }
    }

    // å¾“æ¥­å“¡å‰Šé™¤
    async function deleteUser(userId, userName) {
      if (!confirm(`${userName} ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆâ€»ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰`)) return;

      try {
        const res = await fetch(`/api/users/${userId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyId: COMPANY_ID }) // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ä¼šç¤¾IDã‚‚é€ã‚‹
        });

        if (res.ok) {
          alert('å‰Šé™¤ã—ã¾ã—ãŸ');
          loadUsers(); // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
        } else {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (err) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
      });
    }

    // åˆæœŸèª­ã¿è¾¼ã¿
    loadUsers();
  </script>
</body>
</html>
